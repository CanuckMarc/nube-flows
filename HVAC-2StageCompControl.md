
```


[{"id":"1d23d3ae.f2d2cc","type":"link in","z":"73ad2fd1.fefd8","name":"Zone Temp In (From LoRa RAT)","links":["b7806655.92a168"],"x":295,"y":840,"wires":[["5aac3c19.230454"]]},{"id":"2e5485fc.b119fa","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"23","payloadType":"num","repeat":"60","crontab":"","once":false,"x":150,"y":600,"wires":[["bac5d9cd.12acf8"]]},{"id":"bac5d9cd.12acf8","type":"function","z":"73ad2fd1.fefd8","name":"Set Point","func":"flow.set('setPoint', msg.payload);\nnode.status({fill:\"green\",shape:\"dot\",text:'Set Point: ' + msg.payload});\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":600,"wires":[[]]},{"id":"e853172e.051a28","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"23.5","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":640,"wires":[["bac5d9cd.12acf8"]]},{"id":"ee711284.39442","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"22","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":520,"wires":[["bac5d9cd.12acf8"]]},{"id":"b9c7dc97.b0c74","type":"function","z":"73ad2fd1.fefd8","name":"Stage Deadband","func":"flow.set('stageDeadband', msg.payload);\nnode.status({fill:\"green\",shape:\"dot\",text:'Stage Deadband: ' + msg.payload});\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":420,"wires":[[]]},{"id":"a9143442.b3f3e8","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":320,"wires":[["b4520887.299618"]]},{"id":"21e8a14.73b9c5e","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":true,"x":150,"y":420,"wires":[["b9c7dc97.b0c74"]]},{"id":"86ce3ba1.90d008","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"2","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":360,"wires":[["b4520887.299618"]]},{"id":"2e818a9e.88f886","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"25","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":720,"wires":[["bac5d9cd.12acf8"]]},{"id":"70d1c3d.cd5b23c","type":"function","z":"73ad2fd1.fefd8","name":"Cool Call 1","func":"if(msg.payload.isOn) {\n    node.status({fill:\"green\", shape:\"dot\", text:true});\n    node.send({\n        payload: true,\n        topic: 'cool1'\n    });\n} else if(!msg.payload.isOn) {\n    node.status({fill:\"red\", shape:\"dot\", text:false});\n        node.send({\n        payload: false,\n        topic: 'cool1'\n    });\n}\n","outputs":1,"noerr":0,"x":1290,"y":300,"wires":[["f12edc83.97df7"]]},{"id":"19f54f79.8c9de1","type":"function","z":"73ad2fd1.fefd8","name":"Heat Call 2","func":"if(msg.payload.isOn) {\n    node.status({fill:\"green\", shape:\"dot\", text:true});\n    node.send({\n        payload: true,\n        topic: 'heat2'\n    });\n} else if(!msg.payload.isOn) {\n    node.status({fill:\"red\", shape:\"dot\", text:false});\n        node.send({\n        payload: false,\n        topic: 'heat2'\n    });\n}\n","outputs":1,"noerr":0,"x":1290,"y":540,"wires":[["b5c684af.4f0298"]]},{"id":"e662e0ac.602a3","type":"inject","z":"73ad2fd1.fefd8","name":"loop","topic":"","payload":"","payloadType":"date","repeat":"2","crontab":"","once":false,"x":650,"y":500,"wires":[["e9137235.aefb3"]]},{"id":"e9137235.aefb3","type":"function","z":"73ad2fd1.fefd8","name":"Cool or Heat Stage","func":"var fanEnable = flow.get('fanEnable') || null;\nvar zoneTemp = flow.get('zoneTemp') || null;\nvar setPoint = flow.get('setPoint') || null;\nvar deadband = flow.get('deadband') || null;\nvar stageDeadband = flow.get('stageDeadband') + deadband || null;\n\nvar comp1 = false;\nvar comp2 = false;\nvar heating = false;\nvar cooling = false;\n\nif(fanEnable && zoneTemp && setPoint && deadband && stageDeadband) {\n    if((zoneTemp >= setPoint + deadband) || (zoneTemp <= (setPoint - deadband))) {\n        comp1 = true;\n        \n        if(zoneTemp >= setPoint + deadband){\n            cooling = true;\n            heating = false;\n        } else if(zoneTemp <= (setPoint - deadband)) {\n            heating = true;\n            cooling = false;\n        }\n        \n        if((zoneTemp >= setPoint + stageDeadband) || (zoneTemp <= (setPoint - stageDeadband))) {\n            comp2 = true;\n            \n            if(zoneTemp >= setPoint + stageDeadband){\n                cooling = true;\n                heating = false;\n            } else if(zoneTemp <= (setPoint - stageDeadband)) {\n                heating = true;\n                cooling = false;\n            }\n        } else {\n            comp2 = false;\n        }\n    } else {\n        comp1 = false;\n        comp2 = false;\n        cooling = false;\n        heating = false;\n    }\n} else {\n    comp1 = false;\n    comp2 = false;\n    cooling = false;\n    heating = false;\n}\n\nvar currComp = null;\nif(comp1 && comp2){\n    currComp = 'comp1+comp2';\n} else if (comp1) {\n    currComp = 'comp1';\n} else if (comp2) {\n    currComp = 'comp2';\n} else {\n    currComp = 'off';\n}\n\nnode.status({fill:\"green\", shape:\"dot\", text:\"heating: \" + heating + ', cooling: ' + cooling + ', comp: ' + currComp});\n\nreturn {\n    payload: {\n        fanEnable: fanEnable,\n        comp1: comp1,\n        comp2: comp2,\n        heating: heating,\n        cooling: cooling,\n        setPoint: setPoint,\n        zoneTemp: zoneTemp,\n        heatingSetPoint: setPoint - deadband,\n        coolingSetPoint: setPoint + deadband,\n        deadband: deadband,\n        stageDeadband: stageDeadband\n    }\n};","outputs":1,"noerr":0,"x":690,"y":540,"wires":[["dfe25a83.5d43f8","98524616.a586d8","32d46526.ac0dda","ea22809a.e8e9d","dc751334.e2891"]]},{"id":"f7b4d9ef.9f9278","type":"function","z":"73ad2fd1.fefd8","name":"Time On/Off Delay","func":"var timeoutFunc = context.get('timeoutFunc') || null;\nvar turningOn = context.get('turningOn') || false;\nvar turningOff = context.get('turningOff') || false;\nvar isOn = context.get('isOn') || false;\nvar compTwoOnDelay = flow.get('compTwoOnDelay') || 300000;\nvar compTwoOffDelay = flow.get('compTwoOffDelay') || 5000;\n\nvar enabled = null;\n\nfunction sendMsg() {\n\tmsg.payload.turningOn = turningOn;\n\tmsg.payload.turningOff = turningOff;\n\tmsg.payload.isOn = isOn;\n\tnode.send(msg);\n}\n\nif(msg.payload.fanEnable && msg.payload.heating && msg.payload.comp2) {\n    enabled = true;\n} else {\n    enabled = false;\n}\n\nif(enabled === true) {\n\tif(turningOff) { /* Was turning off but was switched back on before the off delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOff = false;\n\t\tisOn = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOn && !isOn) {  /* Not turning on and not on, so start turning on */\n\t\tturningOn = true;\n\t\tcontext.set('turningOn', turningOn);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = true;\n\t\t\tturningOn = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOn', turningOn);\n\t\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compTwoOnDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOn && !isOn) { /* Is turning on but isn't on yet */\n\t\tsendMsg();\n\t} else {  /* Is already on */\n\t\tsendMsg();\n\t}\n} else if(enabled === false) {\n\tif(turningOn) { /* Was turning on but was switched back off before the on delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOn = false;\n\t\tisOn = false;\n\t\tcontext.set('turningOn', turningOn);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOff && isOn) {  /* Not turning off and is on, so start turning off */\n\t\tturningOff = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = false;\n\t\t\tturningOff = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOff', turningOff);\n\t\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compTwoOffDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOff && isOn) { /* Is turning off but isn't off yet */\n\t\tsendMsg();\n\t} else { /* Is already off */\n\t\tsendMsg();\n\t}\n}","outputs":1,"noerr":0,"x":1110,"y":540,"wires":[["19f54f79.8c9de1"]]},{"id":"b4520887.299618","type":"function","z":"73ad2fd1.fefd8","name":"Deadband","func":"flow.set('deadband', msg.payload);\nnode.status({fill:\"green\",shape:\"dot\",text:'Deadband: ' + msg.payload});\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":320,"wires":[[]]},{"id":"47d284d2.de6f2c","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"24","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":680,"wires":[["bac5d9cd.12acf8"]]},{"id":"5aac3c19.230454","type":"function","z":"73ad2fd1.fefd8","name":"Zone Temp","func":"flow.set('zoneTemp', msg.payload);\nnode.status({fill:\"green\",shape:\"dot\",text:'Zone Temp: ' + msg.payload});\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":860,"wires":[[]]},{"id":"716139c8.f6bb28","type":"function","z":"73ad2fd1.fefd8","name":"Time On/Off Delay","func":"var timeoutFunc = context.get('timeoutFunc') || null;\nvar turningOn = context.get('turningOn') || false;\nvar turningOff = context.get('turningOff') || false;\nvar isOn = context.get('isOn') || false;\nvar compOneOnDelay = flow.get('compOneOnDelay') || 60000;\nvar compOneOffDelay = flow.get('compOneOffDelay') || 5000;\n\nvar enabled = null;\n\nfunction sendMsg() {\n\tmsg.payload.turningOn = turningOn;\n\tmsg.payload.turningOff = turningOff;\n\tmsg.payload.isOn = isOn;\n\tnode.send(msg);\n}\n\nif(msg.payload.fanEnable && msg.payload.cooling && msg.payload.comp1) {\n    enabled = true;\n} else {\n    enabled = false;\n}\n\nif(enabled === true) {\n\tif(turningOff) { /* Was turning off but was switched back on before the off delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOff = false;\n\t\tisOn = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOn && !isOn) {  /* Not turning on and not on, so start turning on */\n\t\tturningOn = true;\n\t\tcontext.set('turningOn', turningOn);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = true;\n\t\t\tturningOn = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOn', turningOn);\n\t\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compOneOnDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOn && !isOn) { /* Is turning on but isn't on yet */\n\t\tsendMsg();\n\t} else {  /* Is already on */\n\t\tsendMsg();\n\t}\n} else if(enabled === false) {\n\tif(turningOn) { /* Was turning on but was switched back off before the on delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOn = false;\n\t\tisOn = false;\n\t\tcontext.set('turningOn', turningOn);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOff && isOn) {  /* Not turning off and is on, so start turning off */\n\t\tturningOff = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = false;\n\t\t\tturningOff = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOff', turningOff);\n\t\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compOneOffDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOff && isOn) { /* Is turning off but isn't off yet */\n\t\tsendMsg();\n\t} else { /* Is already off */\n\t\tsendMsg();\n\t}\n}","outputs":1,"noerr":0,"x":1110,"y":300,"wires":[["70d1c3d.cd5b23c"]]},{"id":"7a360548.8d983c","type":"function","z":"73ad2fd1.fefd8","name":"Cool Call 2","func":"if(msg.payload.isOn) {\n    node.status({fill:\"green\", shape:\"dot\", text:true});\n    node.send({\n        payload: true,\n        topic: 'cool2'\n    });\n} else if(!msg.payload.isOn) {\n    node.status({fill:\"red\", shape:\"dot\", text:false});\n        node.send({\n        payload: false,\n        topic: 'cool2'\n    });\n}\n","outputs":1,"noerr":0,"x":1290,"y":360,"wires":[["b5c684af.4f0298"]]},{"id":"a3ac01d7.0e3a8","type":"function","z":"73ad2fd1.fefd8","name":"Time On/Off Delay","func":"var timeoutFunc = context.get('timeoutFunc') || null;\nvar turningOn = context.get('turningOn') || false;\nvar turningOff = context.get('turningOff') || false;\nvar isOn = context.get('isOn') || false;\nvar compTwoOnDelay = flow.get('compTwoOnDelay') || 300000;\nvar compTwoOffDelay = flow.get('compTwoOffDelay') || 5000;\n\nvar enabled = null;\n\nfunction sendMsg() {\n\tmsg.payload.turningOn = turningOn;\n\tmsg.payload.turningOff = turningOff;\n\tmsg.payload.isOn = isOn;\n\tnode.send(msg);\n}\n\nif(msg.payload.fanEnable && msg.payload.cooling && msg.payload.comp2) {\n    enabled = true;\n} else {\n    enabled = false;\n}\n\nif(enabled === true) {\n\tif(turningOff) { /* Was turning off but was switched back on before the off delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOff = false;\n\t\tisOn = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOn && !isOn) {  /* Not turning on and not on, so start turning on */\n\t\tturningOn = true;\n\t\tcontext.set('turningOn', turningOn);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = true;\n\t\t\tturningOn = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOn', turningOn);\n\t\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compTwoOnDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOn && !isOn) { /* Is turning on but isn't on yet */\n\t\tsendMsg();\n\t} else {  /* Is already on */\n\t\tsendMsg();\n\t}\n} else if(enabled === false) {\n\tif(turningOn) { /* Was turning on but was switched back off before the on delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOn = false;\n\t\tisOn = false;\n\t\tcontext.set('turningOn', turningOn);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOff && isOn) {  /* Not turning off and is on, so start turning off */\n\t\tturningOff = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = false;\n\t\t\tturningOff = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOff', turningOff);\n\t\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compTwoOffDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOff && isOn) { /* Is turning off but isn't off yet */\n\t\tsendMsg();\n\t} else { /* Is already off */\n\t\tsendMsg();\n\t}\n}","outputs":1,"noerr":0,"x":1110,"y":360,"wires":[["7a360548.8d983c"]]},{"id":"a1d8c193.07496","type":"function","z":"73ad2fd1.fefd8","name":"Heat Call 1","func":"if(msg.payload.isOn) {\n    node.status({fill:\"green\", shape:\"dot\", text:true});\n    node.send({\n        payload: true,\n        topic: 'heat1'\n    });\n} else if(!msg.payload.isOn) {\n    node.status({fill:\"red\", shape:\"dot\", text:false});\n        node.send({\n        payload: false,\n        topic: 'heat1'\n    });\n}\n","outputs":1,"noerr":0,"x":1290,"y":480,"wires":[["f12edc83.97df7"]]},{"id":"3a5e7e91.3ad632","type":"function","z":"73ad2fd1.fefd8","name":"Time On/Off Delay","func":"var timeoutFunc = context.get('timeoutFunc') || null;\nvar turningOn = context.get('turningOn') || false;\nvar turningOff = context.get('turningOff') || false;\nvar isOn = context.get('isOn') || false;\nvar compOneOnDelay = flow.get('compOneOnDelay') || 60000;\nvar compOneOffDelay = flow.get('compOneOffDelay') || 5000;\n\nvar enabled = null;\n\nfunction sendMsg() {\n\tmsg.payload.turningOn = turningOn;\n\tmsg.payload.turningOff = turningOff;\n\tmsg.payload.isOn = isOn;\n\tnode.send(msg);\n}\n\nif(msg.payload.fanEnable && msg.payload.heating && msg.payload.comp1) {\n    enabled = true;\n} else {\n    enabled = false;\n}\n\nif(enabled === true) {\n\tif(turningOff) { /* Was turning off but was switched back on before the off delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOff = false;\n\t\tisOn = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOn && !isOn) {  /* Not turning on and not on, so start turning on */\n\t\tturningOn = true;\n\t\tcontext.set('turningOn', turningOn);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = true;\n\t\t\tturningOn = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOn', turningOn);\n\t\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compOneOnDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOn && !isOn) { /* Is turning on but isn't on yet */\n\t\tsendMsg();\n\t} else {  /* Is already on */\n\t\tsendMsg();\n\t}\n} else if(enabled === false) {\n\tif(turningOn) { /* Was turning on but was switched back off before the on delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOn = false;\n\t\tisOn = false;\n\t\tcontext.set('turningOn', turningOn);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOff && isOn) {  /* Not turning off and is on, so start turning off */\n\t\tturningOff = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = false;\n\t\t\tturningOff = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOff', turningOff);\n\t\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, compOneOffDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOff && isOn) { /* Is turning off but isn't off yet */\n\t\tsendMsg();\n\t} else { /* Is already off */\n\t\tsendMsg();\n\t}\n}","outputs":1,"noerr":0,"x":1110,"y":480,"wires":[["a1d8c193.07496"]]},{"id":"dfe25a83.5d43f8","type":"function","z":"73ad2fd1.fefd8","name":"","func":"if(msg.payload.fanEnable && msg.payload.cooling && msg.payload.comp1) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Cooling Comp 1\"});\n    node.send(msg);\n} else {\n    node.status({fill:\"red\", shape:\"dot\", text:\"Off\"});\n    node.send(msg);\n}","outputs":1,"noerr":0,"x":950,"y":300,"wires":[["716139c8.f6bb28"]]},{"id":"98524616.a586d8","type":"function","z":"73ad2fd1.fefd8","name":"","func":"if(msg.payload.fanEnable && msg.payload.cooling && msg.payload.comp2) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Cooling Comp 2\"});\n    node.send(msg);\n} else {\n    node.status({fill:\"red\", shape:\"dot\", text:\"Off\"});\n    node.send(msg);\n}","outputs":1,"noerr":0,"x":950,"y":360,"wires":[["a3ac01d7.0e3a8"]]},{"id":"32d46526.ac0dda","type":"function","z":"73ad2fd1.fefd8","name":"","func":"if(msg.payload.fanEnable && msg.payload.heating && msg.payload.comp1) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Heating Comp 1\"});\n    node.send(msg);\n} else {\n    node.status({fill:\"red\", shape:\"dot\", text:\"Off\"});\n    node.send(msg);\n}","outputs":1,"noerr":0,"x":950,"y":480,"wires":[["3a5e7e91.3ad632"]]},{"id":"ea22809a.e8e9d","type":"function","z":"73ad2fd1.fefd8","name":"","func":"if(msg.payload.fanEnable && msg.payload.heating && msg.payload.comp2) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Heating Comp 2\"});\n    node.send(msg);\n} else {\n    node.status({fill:\"red\", shape:\"dot\", text:\"Off\"});\n    node.send(msg);\n}","outputs":1,"noerr":0,"x":950,"y":540,"wires":[["f7b4d9ef.9f9278"]]},{"id":"d0cc9dc.f62ea6","type":"link out","z":"73ad2fd1.fefd8","name":"Comp 1 Out","links":["e0f1ac44.a96a6"],"x":1615,"y":300,"wires":[]},{"id":"925944b.31bb1b8","type":"link out","z":"73ad2fd1.fefd8","name":"Comp 2 Out","links":["3e6bf5b7.a5796a"],"x":1615,"y":540,"wires":[]},{"id":"b5c684af.4f0298","type":"function","z":"73ad2fd1.fefd8","name":"Comp 2 OR","func":"var coolPayload = context.get('coolPayload') || false;\nvar heatPayload = context.get('heatPayload') || false;\n\nif(msg.topic === 'cool2') {\n    coolPayload = msg.payload;\n}\n\nif(msg.topic === 'heat2') {\n    heatPayload = msg.payload;\n}\n\ncontext.set('coolPayload', coolPayload);\ncontext.set('heatPayload', heatPayload);\n\nif(coolPayload || heatPayload) {\n    node.send({\n        payload: true,\n        topic: 'Comp 2 Call'\n    });\n} else if (!coolPayload && !heatPayload) {\n    node.send({\n        payload: false,\n        topic: 'Comp 2 Call'\n    });\n}","outputs":1,"noerr":0,"x":1510,"y":540,"wires":[["925944b.31bb1b8"]]},{"id":"f12edc83.97df7","type":"function","z":"73ad2fd1.fefd8","name":"Comp 1 OR","func":"var coolPayload = context.get('coolPayload') || false;\nvar heatPayload = context.get('heatPayload') || false;\n\nif(msg.topic === 'cool1') {\n    coolPayload = msg.payload;\n}\n\nif(msg.topic === 'heat1') {\n    heatPayload = msg.payload;\n}\n\ncontext.set('coolPayload', coolPayload);\ncontext.set('heatPayload', heatPayload);\n\nif(coolPayload || heatPayload) {\n    node.send({\n        payload: true,\n        topic: 'Comp 1 Call'\n    });\n} else if (!coolPayload && !heatPayload) {\n    node.send({\n        payload: false,\n        topic: 'Comp 1 Call'\n    });\n}","outputs":1,"noerr":0,"x":1510,"y":300,"wires":[["d0cc9dc.f62ea6"]]},{"id":"74e93b51.e30f04","type":"function","z":"73ad2fd1.fefd8","name":"RV ON","func":"if(msg.payload.heating && msg.payload.isOn) {\n    node.send({\n        payload: true,\n        topic: 'RV Call'\n    });\n} else if(!msg.payload.isOn) {\n    node.send({\n        payload: false,\n        topic: 'RV Call'\n    });\n}","outputs":1,"noerr":0,"x":1500,"y":420,"wires":[["d81d958e.9c9d08"]]},{"id":"d81d958e.9c9d08","type":"link out","z":"73ad2fd1.fefd8","name":"RV Out","links":["7ead4bca.d747c4"],"x":1615,"y":420,"wires":[]},{"id":"f62a2b19.e308a8","type":"function","z":"73ad2fd1.fefd8","name":"RV Call","func":"if(msg.payload.isOn) {\n    node.status({fill:\"green\", shape:\"dot\", text:true});\n    node.send(msg);\n} else if(!msg.payload.isOn) {\n    node.status({fill:\"red\", shape:\"dot\", text:false});\n    node.send(msg);\n}","outputs":1,"noerr":0,"x":1280,"y":420,"wires":[["74e93b51.e30f04"]]},{"id":"3a597820.fb27d8","type":"function","z":"73ad2fd1.fefd8","name":"Time On/Off Delay","func":"var timeoutFunc = context.get('timeoutFunc') || null;\nvar turningOn = context.get('turningOn') || false;\nvar turningOff = context.get('turningOff') || false;\nvar isOn = context.get('isOn') || false;\nvar reversingValveOnDelay = flow.get('reversingValveOnDelay') || 30000;\nvar reversingValveOffDelay = flow.get('reversingValveOffDelay') || 30000;\n\nvar enabled = null;\n\nfunction sendMsg() {\n\tmsg.payload.turningOn = turningOn;\n\tmsg.payload.turningOff = turningOff;\n\tmsg.payload.isOn = isOn;\n\tnode.send(msg);\n}\n\nif(msg.payload.fanEnable && msg.payload.heating && msg.payload.comp1) {\n    enabled = true;\n} else {\n    enabled = false;\n}\n\nif(enabled === true) {\n\tif(turningOff) { /* Was turning off but was switched back on before the off delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOff = false;\n\t\tisOn = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOn && !isOn) {  /* Not turning on and not on, so start turning on */\n\t\tturningOn = true;\n\t\tcontext.set('turningOn', turningOn);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = true;\n\t\t\tturningOn = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOn', turningOn);\n\t\t\tnode.status({fill:\"green\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, reversingValveOnDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOn && !isOn) { /* Is turning on but isn't on yet */\n\t\tsendMsg();\n\t} else {  /* Is already on */\n\t\tsendMsg();\n\t}\n} else if(enabled === false) {\n\tif(turningOn) { /* Was turning on but was switched back off before the on delay elapsed */\n\t\tclearTimeout(timeoutFunc);\n\t\tturningOn = false;\n\t\tisOn = false;\n\t\tcontext.set('turningOn', turningOn);\n\t\tcontext.set('isOn', isOn);\n\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\tsendMsg();\n\t} else if(!turningOff && isOn) {  /* Not turning off and is on, so start turning off */\n\t\tturningOff = true;\n\t\tcontext.set('turningOff', turningOff);\n\t\tnode.status({fill:\"yellow\",shape:\"dot\",text:\"Busy\"});\n\t\ttimeoutFunc = setTimeout(function(){\n\t\t\tisOn = false;\n\t\t\tturningOff = false;\n\t\t\tcontext.set('isOn', isOn);\n\t\t\tcontext.set('turningOff', turningOff);\n\t\t\tnode.status({fill:\"red\",shape:\"dot\",text:enabled});\n\t\t\tsendMsg();\n\t\t}, reversingValveOffDelay);\n\t\tcontext.set('timeoutFunc', timeoutFunc);\n\t} else if(turningOff && isOn) { /* Is turning off but isn't off yet */\n\t\tsendMsg();\n\t} else { /* Is already off */\n\t\tsendMsg();\n\t}\n}","outputs":1,"noerr":0,"x":1110,"y":420,"wires":[["f62a2b19.e308a8"]]},{"id":"dc751334.e2891","type":"function","z":"73ad2fd1.fefd8","name":"","func":"if(msg.payload.fanEnable && msg.payload.heating && msg.payload.comp1) {\n    node.status({fill:\"green\", shape:\"dot\", text:\"Reversing Valve\"});\n    node.send(msg);\n} else {\n    node.status({fill:\"red\", shape:\"dot\", text:\"Off\"});\n    node.send(msg);\n}","outputs":1,"noerr":0,"x":950,"y":420,"wires":[["3a597820.fb27d8"]]},{"id":"bf4573c5.699aa","type":"function","z":"73ad2fd1.fefd8","name":"Timing Delays","func":"var compOneOnDelay = 60000;         // 1 Minute\nvar compOneOffDelay = 5000;         // 5 Seconds\nvar compTwoOnDelay = 300000;        // 5 Minute \nvar compTwoOffDelay = 5000;         // 5 Seconds\nvar reversingValveOnDelay = 30000;  // 30 Seconds\nvar reversingValveOffDelay = 30000; // 30 Seconds\n\nflow.set('compOneOnDelay', compOneOnDelay);\nflow.set('compTwoOnDelay', compTwoOnDelay);\nflow.set('compOneOffDelay', compOneOffDelay);\nflow.set('compTwoOffDelay', compTwoOffDelay);\nflow.set('reversingValveOnDelay', reversingValveOnDelay);\nflow.set('reversingValveOffDelay', reversingValveOffDelay);\n\nnode.status({fill:\"green\",shape:\"dot\",text:'Set'});","outputs":1,"noerr":0,"x":360,"y":220,"wires":[[]]},{"id":"eb72dab.f084428","type":"inject","z":"73ad2fd1.fefd8","name":"set","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"x":150,"y":220,"wires":[["bf4573c5.699aa"]]},{"id":"ba49f126.85f92","type":"inject","z":"73ad2fd1.fefd8","name":"loop","topic":"loop","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"x":150,"y":160,"wires":[["fb9ae457.aec758"]]},{"id":"204c255e.1cc3fa","type":"function","z":"73ad2fd1.fefd8","name":"Overide Loop Function","func":"msg.topic = 'toggleEnable';\nnode.status({fill:msg.payload ? \"green\" : \"red\", shape:\"dot\", text:msg.payload});\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":80,"wires":[["c9c3717c.87501"]]},{"id":"53fde9ad.b10078","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"true","payloadType":"bool","repeat":"60","crontab":"","once":true,"x":150,"y":60,"wires":[["204c255e.1cc3fa"]]},{"id":"802f111f.750a6","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":false,"x":150,"y":100,"wires":[["204c255e.1cc3fa"]]},{"id":"fb9ae457.aec758","type":"function","z":"73ad2fd1.fefd8","name":"Scheduler","func":"var now = new Date().toLocaleString('en-UK', {\n    timeZone: 'Australia/Sydney'\n});\n\nnow = new Date(now);\n\nvar status = [\"Current: \" + now];\n\nvar holidays = {\n    '2017-12-25': \"Christmas\",\n    '2017-12-26': \"Boxing Day\",\n    '2018-01-01': \"New Years Day\",\n};\n\nvar weekly_sched = {\n    'Monday':    {start: {hour:7,minute:30}, finish: {hour:18,minute:30}},\n    'Tuesday':   {start: {hour:7,minute:30}, finish: {hour:18,minute:30}},\n    'Wednesday': {start: {hour:7,minute:30}, finish: {hour:18,minute:30}},\n    'Thursday':  {start: {hour:7,minute:30}, finish: {hour:18,minute:30}},\n    'Friday':    {start: {hour:7,minute:30}, finish: {hour:18,minute:30}},\n    'Saturday':  {start: {hour:0,minute:0}, finish: {hour:0,minute:0}},\n    'Sunday':    {start: {hour:0,minute:0}, finish: {hour:0,minute:0}},\n};\n\nDate.prototype.yyyymmdd = function() {\n    var mm = this.getMonth() + 1;\n    var dd = this.getDate();\n    \n    return [this.getFullYear(),\n        (mm>9 ? '' : '0') + mm,\n        (dd>9 ? '' : '0') + dd\n        ].join('-');\n};\n\nis_holiday = function(data, dt) {\n    var str = dt.yyyymmdd();\n    var ret = str in data;\n\n    if(ret) {\n        status.push(\" Holiday: \" + data[str]);\n    }\n    return ret;\n};\n\nin_operating_hours = function(data, dt) {\n    var ret = true;\n    var dow = dt.getDay();\n    var das = {\n        1: 'Monday',\n        2: 'Tuesday',\n        3: 'Wednesday',\n        4: 'Thursday',\n        5: 'Friday',\n        6: 'Saturday',\n        7: 'Sunday',\n    };\n\n    var hours = data[das[dow]];  \n    \n    \n    var sod = new Date().toLocaleString('en-UK', {\n        timeZone: 'Australia/Sydney'\n    });\n    sod = new Date(sod);\n    sod.setHours(hours.start.hour);\n    sod.setMinutes('minute' in hours.start ? hours.start.minute : 0);\n    sod.setSeconds(0);\n    sod.setMilliseconds(0);\n\n    var eod = new Date().toLocaleString('en-UK', {\n        timeZone: 'Australia/Sydney'\n    });\n    eod = new Date(eod);\n    eod.setHours(hours.finish.hour);\n    eod.setMinutes('minute' in hours.finish ? hours.finish.minute : 0);\n    eod.setSeconds(0);\n    eod.setMilliseconds(0);\n    \n    if((dt.getTime() <= eod.getTime()) && (dt.getTime() >= sod.getTime())){\n        ret = true;\n    } else {\n        ret = false;\n    }\n    \n    if(!ret) {\n        status.push(\" Out of hours\");\n    }\n    \n    return ret;\n};\n\nvar enable = true;\n\nenable = !is_holiday(holidays, now) && in_operating_hours(weekly_sched, now);\n\nnode.status({fill:enable ? \"green\" : \"red\", shape:\"ring\", text: status});\n\nreturn {\n    payload: enable,\n    topic: 'scheduleEnable'\n};","outputs":1,"noerr":0,"x":340,"y":160,"wires":[["c9c3717c.87501"]]},{"id":"415b9477.000adc","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"22.5","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":560,"wires":[["bac5d9cd.12acf8"]]},{"id":"cfb321dc.db798","type":"link out","z":"73ad2fd1.fefd8","name":"Fan Enable Out","links":["ee457a11.24ae48"],"x":935,"y":80,"wires":[]},{"id":"c9c3717c.87501","type":"function","z":"73ad2fd1.fefd8","name":"Fan Enabled","func":"var scheduleEnable = context.get('scheduleEnable') || false;\nvar toggleEnable = context.get('toggleEnable') || false;\n\nif(msg.topic === 'scheduleEnable') {\n    scheduleEnable = msg.payload;\n} else if (msg.topic === 'toggleEnable'){\n    toggleEnable = msg.payload;\n}\n\ncontext.set('scheduleEnable', scheduleEnable);\ncontext.set('toggleEnable', toggleEnable);\n\nif(toggleEnable && scheduleEnable) {\n    node.status({fill:\"green\", shape:\"dot\", text:true});\n    return { \n        payload: true,\n        topic: \"Fan Enable\"\n    };\n} else {\n    node.status({fill:\"red\", shape:\"dot\", text:false});\n    return { \n        payload: false,\n        topic: \"Fan Enable\"\n    };\n}","outputs":1,"noerr":0,"x":610,"y":80,"wires":[["cfb321dc.db798"]]},{"id":"ebfff7d3.5b5b08","type":"comment","z":"73ad2fd1.fefd8","name":"Toggle Enable AND Scheduler","info":"","x":660,"y":40,"wires":[]},{"id":"3421ad83.e4e7e2","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"0.5","payloadType":"num","repeat":"","crontab":"","once":true,"x":150,"y":280,"wires":[["b4520887.299618"]]},{"id":"50179889.bc9228","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"21","payloadType":"num","repeat":"","crontab":"","once":false,"x":150,"y":480,"wires":[["bac5d9cd.12acf8"]]},{"id":"681f4b9a.28f614","type":"link in","z":"73ad2fd1.fefd8","name":"Zone Temp In (From UI2 RAT)","links":["d1e51009.4b202"],"x":295,"y":880,"wires":[[]]},{"id":"a419ea94.e80928","type":"comment","z":"73ad2fd1.fefd8","name":"From LoRa RAT","info":"","x":120,"y":840,"wires":[]},{"id":"e5f6c21.d58124","type":"comment","z":"73ad2fd1.fefd8","name":"From UI2 RAT","info":"","x":110,"y":880,"wires":[]},{"id":"8cbe5a79.b20258","type":"link in","z":"73ad2fd1.fefd8","name":"","links":["c617fb2.7f50f08"],"x":1055,"y":80,"wires":[["a69f4871.0a5ac8"]]},{"id":"a69f4871.0a5ac8","type":"function","z":"73ad2fd1.fefd8","name":"Fan Status Context","func":"if(msg.payload === true) {\n    flow.set('fanEnable', msg.payload);\n    node.status({fill:\"green\", shape:\"dot\", text:msg.payload});\n} else {\n    flow.set('fanEnable', msg.payload);\n    node.status({fill:\"red\", shape:\"dot\", text:msg.payload});\n}","outputs":1,"noerr":0,"x":1190,"y":80,"wires":[[]]},{"id":"51e512ed.bd227c","type":"inject","z":"73ad2fd1.fefd8","name":"","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":false,"x":790,"y":140,"wires":[["cfb321dc.db798"]]}]



```
